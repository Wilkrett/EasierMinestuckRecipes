<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minestuck Gristcost Datapack Json Thing</title>
  <!-- Bootstrap CSS -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Minestuck Gristcost Datapack Json Thing</h2>
    <form id="recipeForm">

      <div class="form-group">
        <label for="ingredient-tag">Ingredient Tag:</label>
        <input type="text" class="form-control" id="ingredient-tag" name="ingredient-tag" placeholder='item' required>
        <small class="form-text">Examples: supplementaries:bomb_blue, #forge:ingots/steel</small>
      </div>

      <div id="gristCostSection">
        
      </div>

      <button type="button" class="btn btn-minestuck" id="addGristBtn">Add Grist</button>
      <button type="submit" class="btn btn-minestuck">Generate Recipe</button>
    </form>
    <div id="jsonDisplay"></div>
  </div>

  <!-- popup -->
  <div class="modal" id="imageModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h4 class="modal-title">Select Grist</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>

        <div class="modal-body">
          <div class="gallery">
            <img src="img/grist/amber.png" class="gallery-item" data-grist="amber">
            <img src="img/grist/amethyst.png" class="gallery-item" data-grist="amethyst">
            <img src="img/grist/artifact.png" class="gallery-item" data-grist="artifact">
            <img src="img/grist/build.png" class="gallery-item" data-grist="build">
            <img src="img/grist/chalk.png" class="gallery-item" data-grist="chalk">
            <img src="img/grist/caulk.png" class="gallery-item" data-grist="caulk">
            <img src="img/grist/cobalt.png" class="gallery-item" data-grist="cobalt">
            <img src="img/grist/diamond.png" class="gallery-item" data-grist="diamond">
            <img src="img/grist/garnet.png" class="gallery-item" data-grist="garnet">
            <img src="img/grist/gold.png" class="gallery-item" data-grist="gold">
            <img src="img/grist/iodine.png" class="gallery-item" data-grist="iodine">
            <img src="img/grist/marble.png" class="gallery-item" data-grist="marble">
            <img src="img/grist/mercury.png" class="gallery-item" data-grist="mercury">
            <img src="img/grist/quartz.png" class="gallery-item" data-grist="quartz">
            <img src="img/grist/ruby.png" class="gallery-item" data-grist="ruby">
            <img src="img/grist/rust.png" class="gallery-item" data-grist="rust">
            <img src="img/grist/shale.png" class="gallery-item" data-grist="shale">
            <img src="img/grist/sulfur.png" class="gallery-item" data-grist="sulfur">
            <img src="img/grist/uranium.png" class="gallery-item" data-grist="uranium">
            <img src="img/grist/zillium.png" class="gallery-item" data-grist="zillium">
            <img src="img/grist/dummy.png" class="gallery-item" data-grist="dummy">
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <script>
      document.getElementById('addGristBtn').addEventListener('click', function() {
        $('#imageModal').modal('show');
      });
    
      $(document).on('click', '.gallery-item', function() {
        const grist = $(this).data('grist');
        createGristCard(grist);
        $(this).addClass('selected').off('click');
        $('#imageModal').modal('hide');
      });
    
      function createGristCard(grist) {
        const gristCount = $('.grist-card').length;
    
        const gristCostSection = document.getElementById('gristCostSection');
    
        const gristCard = document.createElement('div');
        gristCard.classList.add('grist-card');
    
        gristCard.innerHTML = `
          <div class="form-group">
            <img src="img/grist/${grist}.png" width="50" height="50">
            <input type="hidden" id="image-${gristCount}" name="image-${gristCount}" value="${grist}">
          </div>
          <div class="form-group">
            <label for="grist-cost-${gristCount}">Grist Cost ${gristCount+1}:</label>
            <input type="number" class="form-control" id="grist-cost-${gristCount}" name="grist-cost-${gristCount}" required>
          </div>
          <div class="form-group">
            <button type="button" class="btn btn-minestuck" onclick="this.parentNode.parentNode.remove()">Remove</button>
          </div>
        `;

        if (grist === 'dummy') {
          gristCard.children[1].innerHTML += `
            <div class="form-group mt-1">
              <input type="text" class="form-control" name="grist-type-${gristCount}" placeholder="grist type" required>
            </div>`;
          gristCard.children[1].classList.add('mb-0')
        }
    
        gristCostSection.appendChild(gristCard);
    
      }
      
      document.getElementById('recipeForm').addEventListener('submit', function(event) {
          event.preventDefault();

          const rawIngredient = document.getElementById('ingredient-tag').value;
          const ingredientTag = rawIngredient.startsWith("#")?
            {tag: rawIngredient.substring(1)}:
            {item: rawIngredient};

          const gristCosts = {};

          $('.grist-card').each(function(index) {
          const gristCostInput = parseInt($(this).find(`#grist-cost-${index}`).val());
          const selectedImage = $(this).find(`#image-${index}`).val();
          if (selectedImage === 'dummy') {
            gristCosts[$(this).find('input[type=text]').val()] = gristCostInput
          } else {
            gristCosts[`minestuck:${selectedImage}`] = gristCostInput;
          }
          });

          const recipeJSON = {
          "type": "minestuck:grist_cost",
          "grist_cost": gristCosts,
          "ingredient": ingredientTag
          };

          const jsonDisplay = document.getElementById('jsonDisplay');
          jsonDisplay.textContent = JSON.stringify(recipeJSON, null, 2);
      });
    </script>
  </body>
</html>
